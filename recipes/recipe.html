<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recipe</title>

  <!-- Reuse your site styles -->
  <link rel="stylesheet" href="../meal-planner.css" />

  <style>
    .recipe-wrap{ max-width:1100px; margin:2rem auto; padding:0 1rem; }
    .recipe-card{
      display:grid;
      grid-template-columns:1fr 2fr;  /* image 1/3, text 2/3 */
      gap:1rem;
      align-items:start;              /* prevent image stretch */
      background:rgba(255,255,255,.65);
      backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,.3);
      border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.1);
      overflow:hidden;
    }
    .recipe-media{
      margin:0;
      width:100%;
      height:auto;
      align-self:start;
      display:block;
      background:#f3f4f6;
      overflow:hidden;
    }
    .recipe-media img{
      display:block;
      width:100%;
      height:auto;
      object-fit:contain; /* no cropping */
    }
    .recipe-body{
      padding:1rem;
      min-width:0; /* prevent text overlap */
    }
    .recipe-header{ display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; }
    .recipe-header h1{ margin:.25rem 0; font-size:1.8rem; }
    .tag{ display:inline-block; font-size:.75rem; padding:.15rem .5rem; border:1px solid #e5e7eb; border-radius:999px; color:#475569 }
    .servings{
      display:inline-flex; align-items:center; gap:.45rem; padding:.25rem .6rem;
      border:1px solid #e5e7eb; border-radius:999px; background:#fff; margin:.25rem 0 0;
    }
    .servings input{ width:6ch; border:0; outline:none; background:transparent; font:inherit; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:.75rem; }
    h2{ font-size:1.1rem; margin:0 0 .4rem; color:#334155 }
    ul.ing{ list-style:none; padding:0; margin:0; }
    ul.ing li{ padding:.25rem 0; border-bottom:1px dashed #e5e7eb; }
    .nutri{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; font-size:.95rem; color:#475569 }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border:1px solid #e5e7eb; border-radius:999px; background:#fff; font-variant-numeric:tabular-nums; }
    ol.dir{ margin:.25rem 0 0 1.1rem; }
    .actions{ display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem; }
    .btn{ display:inline-block; text-decoration:none; border:1px solid #e5e7eb; border-radius:999px; padding:.45rem .8rem; background:#fff; color:#0f172a; font:inherit; cursor:pointer; }
    @media(max-width:900px){
      .recipe-card{ grid-template-columns:1fr; }
    }
  </style>

  <!-- Load databases first -->
  <script src="../ingredients-db.js"></script>
  <script src="../recipes.js"></script>
</head>
<body>
  <main class="recipe-wrap">
    <nav class="site-nav" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.75rem;">
      <a class="btn" href="../index.html">← Back to Planner</a>
      <a class="btn" id="openRaw" href="#" target="_blank" rel="noopener">Open raw URL</a>
    </nav>

    <section class="recipe-card">
      <figure class="recipe-media">
        <img id="photo" src="../images/no-image.jpg" alt="Recipe image placeholder" />
      </figure>

      <div class="recipe-body">
        <div class="recipe-header">
          <h1 id="title">Recipe</h1>
          <span class="tag" id="rtype">Type</span>
        </div>

        <div class="servings">
          <label for="servings">Servings</label>
          <input id="servings" type="number" step="0.25" min="0" value="1" inputmode="decimal" />
          <small id="servingsMeta"></small>
        </div>

        <div class="grid-2">
          <div>
            <h2>Ingredients</h2>
            <ul class="ing" id="ingredients"></ul>
          </div>
          <div>
            <h2>Nutrition (scaled)</h2>
            <div class="nutri" id="nutrition"></div>
          </div>
        </div>

        <div style="margin-top:1rem;">
          <h2>Directions</h2>
          <ol class="dir" id="directions"></ol>
        </div>

        <div class="actions">
          <button class="btn" id="printBtn">Print</button>
          <button class="btn" id="copyLink">Copy link</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Nutrition helpers + calculator -->
  <script>
    function toMl(q, unit){
      const u = (unit||'').toLowerCase().trim();
      if (u === 'tsp' || u === 'teaspoon' || u === 'teaspoons') return q * 4.9289215938;
      if (u === 'tbsp' || u === 'tablespoon' || u === 'tablespoons') return q * 14.786764781;
      if (u === 'fl oz' || u === 'floz' || u === 'fluid ounce' || u === 'fluid ounces') return q * 29.573529562;
      if (u === 'cup' || u === 'cups') return q * 236.5882365;
      if (u === 'ml' || u === 'milliliter' || u === 'milliliters') return q;
      if (u === 'l' || u === 'liter' || u === 'liters') return q * 1000;
      return null;
    }
    function toGramsFromMass(q, unit){
      const u = (unit||'').toLowerCase().trim();
      if (u === 'g' || u === 'gram' || u === 'grams') return q;
      if (u === 'kg' || u === 'kilogram' || u === 'kilograms') return q * 1000;
      if (u === 'oz' || u === 'ounce' || u === 'ounces') return q * 28.349523125;
      if (u === 'lb' || u === 'lbs' || u === 'pound' || u === 'pounds') return q * 453.59237;
      return null;
    }
    function toGramsFromCount(q, unit, ingMeta){
      const u = (unit||'').toLowerCase().trim();
      const per = ingMeta && ingMeta.weight_g_per_pc ? ingMeta.weight_g_per_pc : null;
      if (!per) return null;
      if (['pc','piece','pieces','slice','slices','clove','cloves','ball','balls'].includes(u) || u === '') {
        return q * per;
      }
      return null;
    }
    function gramsFor(ing){
      const key  = (ing.name||'').toLowerCase().trim();
      const meta = (window.__INGREDIENTS || {})[key];
      const qty  = +ing.qty || 0;
      const unit = (ing.unit||'').trim();

      if (!meta) { console.warn('No ingredient meta for:', ing.name); return 0; }

      let g = toGramsFromMass(qty, unit);
      if (g !== null) return g;

      const ml = toMl(qty, unit);
      if (ml !== null) {
        if (typeof meta.density_g_per_ml === 'number') return ml * meta.density_g_per_ml;
        console.warn('No density for volume unit on:', ing.name);
        return 0;
      }

      const gp = toGramsFromCount(qty, unit, meta);
      if (gp !== null) return gp;

      console.warn('Unrecognized unit for:', ing.name, 'unit=', unit);
      return 0;
    }
    function computeNutrition(ingredients, factor){
      let totG = 0, p=0, c=0, f=0, kcal=0;
      (ingredients||[]).forEach(ing => {
        const grams = gramsFor(ing) * (factor || 1);
        if (grams <= 0) return;
        const meta = (window.__INGREDIENTS || {})[(ing.name||'').toLowerCase().trim()];
        const per100 = meta && meta.per100g ? meta.per100g : null;
        if (!per100) return;

        const scale = grams / 100;
        p   += (per100.protein || 0) * scale;
        c   += (per100.carbs   || 0) * scale;
        f   += (per100.fat     || 0) * scale;
        kcal+= (per100.cal     || 0) * scale;
        totG+= grams;
      });
      return { protein:p, carbs:c, fat:f, calories:kcal, weight_g:totG };
    }
  </script>

  <!-- Main page logic (this was missing <script> before) -->
  <script>
    (function(){
      const params = new URLSearchParams(location.search);
      const id = params.get('id') || '';
      const list = Array.isArray(window.__RECIPES) ? window.__RECIPES : [];
      const r = list.find(x => x.id === id);

      const titleEl = document.getElementById('title');
      const typeEl  = document.getElementById('rtype');
      const servingsInput = document.getElementById('servings');
      const servingsMeta  = document.getElementById('servingsMeta');
      const ingEl   = document.getElementById('ingredients');
      const nutEl   = document.getElementById('nutrition');
      const dirEl   = document.getElementById('directions');
      const openRaw = document.getElementById('openRaw');

      if (!r) {
        titleEl.textContent = 'Recipe not found';
        typeEl.textContent = 'N/A';
        dirEl.innerHTML = '<li>Invalid recipe id.</li>';
        return;
      }

      document.title = r.title + ' — Recipe';
      titleEl.textContent = r.title;
      typeEl.textContent = (r.type || '').charAt(0).toUpperCase() + (r.type||'').slice(1);

      // If you add an "image" field in recipes.js, uncomment this:
      // if (r.image) document.getElementById('photo').src = r.image;

      if (r.url) { openRaw.href = r.url; } else { openRaw.style.display = 'none'; }

      const base = Math.max(1, +r.baseServings || 1);
      const sParam = parseFloat(new URLSearchParams(location.search).get('s'));
      const initialServings = (!isNaN(sParam) && sParam >= 0) ? sParam : base;
      servingsInput.value = initialServings;
      servingsMeta.textContent = `(base ${base} ${base === 1 ? 'serving' : 'servings'})`;

      function render() {
        const s = Math.max(0, +servingsInput.value || 0);
        const factor = s / base;

        // Ingredients
        ingEl.innerHTML = '';
        (r.ingredients || []).forEach(ing => {
          const li = document.createElement('li');
          const qty = (Math.round((+ing.qty || 0) * factor * 100) / 100);
          const qtyStr = isNaN(qty) ? '' : qty.toString();
          const unit = ing.unit ? ` ${ing.unit}` : '';
          li.textContent = `${qtyStr}${unit} ${ing.name}`;
          ingEl.appendChild(li);
        });

        // Dynamic nutrition calc:
        const totals = computeNutrition(r.ingredients, factor);
        nutEl.innerHTML = `
          <span class="chip"><strong>P</strong> ${totals.protein.toFixed(1)} g</span>
          <span class="chip"><strong>C</strong> ${totals.carbs.toFixed(1)} g</span>
          <span class="chip"><strong>F</strong> ${totals.fat.toFixed(1)} g</span>
          <span class="chip"><strong>kcal</strong> ${Math.round(totals.calories)}</span>
          <span class="chip" title="approx total finished mass"><strong>wt</strong> ${Math.round(totals.weight_g)} g</span>
        `;

        // Directions
        dirEl.innerHTML = '';
        const steps = Array.isArray(r.directions) && r.directions.length ? r.directions
                     : ['Write your steps in recipes.js under this recipe’s "directions" array.'];
        steps.forEach(txt => {
          const li = document.createElement('li');
          li.textContent = txt;
          dirEl.appendChild(li);
        });
      }

      servingsInput.addEventListener('change', render);
      servingsInput.addEventListener('keyup', e => { if (e.key === 'Enter') render(); });
      document.getElementById('printBtn').addEventListener('click', () => window.print());
      document.getElementById('copyLink').addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(location.href); alert('Link copied!'); } catch {}
      });

      render();
    })();
  </script>
</body>
</html>
